import React, { useEffect, useState } from 'react';
import { useAuth } from '../contexts/AuthContext';
import { apiService } from '../services/api';
import type { TransactionResponseDTO } from '../services/api';
import TransactionView from './TransactionView';
import jsPDF from 'jspdf';

interface Metric {
  icon: string;
  value: string;
  label: string;
  trend: string;
  trendType: string;
  details: string[];
}

interface FinancialSummaryItem {
  label: string;
  value: string;
  type: 'profit' | 'expense' | 'warning';
  total?: boolean;
}

const Dashboard: React.FC = () => {
  const { user, logout, forceLogout } = useAuth();
  const [transactions, setTransactions] = useState<TransactionResponseDTO[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  const [metrics, setMetrics] = useState<Metric[]>([]);
  const [financialSummary, setFinancialSummary] = useState<FinancialSummaryItem[]>([]);
  const [recentActivities, setRecentActivities] = useState<any[]>([]);
  const [modalOpen, setModalOpen] = useState(false);
  const [selectedTransaction, setSelectedTransaction] = useState<TransactionResponseDTO | null>(null);

  useEffect(() => {
    async function fetchTransactions() {
      setLoading(true);
      setError(null);
      try {
        const res = await apiService.getAllTransactions();
        const txs = res.content || [];
        setTransactions(txs);
        // CÃ¡lculos
        const now = new Date();
        const thisMonth = now.getMonth() + 1;
        const thisYear = now.getFullYear();
        const prevMonth = thisMonth === 1 ? 12 : thisMonth - 1;
        const prevMonthYear = thisMonth === 1 ? thisYear - 1 : thisYear;

        // Filtros
        const completed = txs.filter(t => t.status === 'completed');
        const income = completed.filter(t => t.type === 'INCOME');
        const expense = completed.filter(t => t.type === 'EXPENSE');
        // Valor total apenas das transaÃ§Ãµes pendentes (status 'PENDING')
        const pendingTxs = txs.filter(t => t.status && t.status.toUpperCase() === 'PENDING');
        const totalValue = pendingTxs.reduce((sum, t) => sum + t.amount, 0);
        // Quantidade de transaÃ§Ãµes pendentes (status 'PENDING')
        const totalPendingCount = pendingTxs.length;
        const monthPendingCount = pendingTxs.filter(t => {
          const d = new Date(t.createdAt);
          return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
        }).length;
        const prevMonthPendingCount = pendingTxs.filter(t => {
          const d = new Date(t.createdAt);
          return d.getMonth() === prevMonth && d.getFullYear() === prevMonthYear;
        }).length;
        // Taxa de sucesso das transaÃ§Ãµes pendentes
        const successRate = txs.length > 0 ? (totalPendingCount / txs.length) * 100 : 0;

        // FunÃ§Ã£o utilitÃ¡ria para pegar mÃªs/ano de uma transaÃ§Ã£o (usando apenas dueDate)
        const getMonthYear = (t: TransactionResponseDTO) => {
          if (!t.dueDate) return { month: -1, year: -1 };
          const [year, month] = t.dueDate.split('-');
          return { month: Number(month), year: Number(year) };
        };

        // Valor total de receitas (todas)
        const monthIncome = txs.filter(t =>
          t.status && t.status.toLowerCase() === 'completed' &&
          t.type === 'INCOME'
        ).reduce((sum, t) => sum + t.amount, 0);

        // Valor total de despesas (todas)
        const monthExpense = txs.filter(t =>
          t.status && t.status.toLowerCase() === 'completed' &&
          t.type === 'EXPENSE'
        ).reduce((sum, t) => sum + t.amount, 0);
        // Lucro lÃ­quido do mÃªs
        const netProfit = monthIncome - monthExpense;
        // Atividades recentes (Ãºltimas 5)
        const activities = txs
          .sort((a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime())
          .slice(0, 5)
          .map(t => ({
            id: t.id,
            icon: t.type === 'INCOME' ? 'ðŸ’°' : 'ðŸ“‹',
            message: (t as any).title || t.description,
            time: (() => {
              // Formatar manualmente a data YYYY-MM-DD para DD/MM/YYYY
              const [year, month, day] = String(t.createdAt).split('-');
              return `${day}/${month}/${year}`;
            })(),
            status: t.status
          }));
        setRecentActivities(activities);
        // Atualiza mÃ©tricas
        setMetrics([
          {
            icon: 'ðŸ’°',
            value: totalValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
            label: 'Valor Total em TransaÃ§Ãµes Pendentes',
            trend: '',
            trendType: 'warning',
            details: [
              `Este mÃªs: ${monthPendingCount} transaÃ§Ãµes`,
              `MÃªs anterior: ${prevMonthPendingCount} transaÃ§Ãµes`
            ]
          },
          {
            icon: 'ðŸ“Š',
            value: totalPendingCount.toString(),
            label: 'TransaÃ§Ãµes Pendentes',
            trend: '',
            trendType: 'warning',
            details: [
              `Este mÃªs: ${monthPendingCount} transaÃ§Ãµes`,
              `MÃªs anterior: ${prevMonthPendingCount} transaÃ§Ãµes`
            ]
          },
          {
            icon: 'ðŸŽ¯',
            value: `${successRate.toFixed(1)}%`,
            label: 'Taxa de Sucesso (Pendentes)',
            trend: '',
            trendType: 'warning',
            details: [
              `Taxa de pendentes sobre o total: ${successRate.toFixed(1)}%`,
              totalPendingCount === 0 ? 'Nenhuma pendente' : 'HÃ¡ pendentes a resolver'
            ]
          }
        ]);
        // Atualiza resumo financeiro
        setFinancialSummary([
          { label: 'Receitas do MÃªs', value: monthIncome.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }), type: 'profit' },
          { label: 'Despesas do MÃªs', value: monthExpense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }), type: 'expense' },
          { label: 'Total LÃ­quido', value: (monthIncome - monthExpense).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }), type: (monthIncome - monthExpense) >= 0 ? 'profit' : 'expense', total: true },
        ]);
      } catch (e: any) {
        setError(e.message || 'Erro ao buscar transaÃ§Ãµes');
      } finally {
        setLoading(false);
      }
    }
    fetchTransactions();
  }, []);

  const handleLogout = async () => {
    try {
      await logout();
    } catch (error) {
      // Se o logout normal falhar, forÃ§ar o logout local
      forceLogout();
    }
  };

  // FunÃ§Ã£o para gerar PDF do relatÃ³rio mensal
  const handleDownloadMonthlyReport = () => {
    // Filtrar transaÃ§Ãµes do mÃªs atual
    const now = new Date();
    const thisMonth = now.getMonth() + 1;
    const thisYear = now.getFullYear();
    const getMonthYear = (t: TransactionResponseDTO) => {
      if (!t.dueDate) return { month: -1, year: -1 };
      const [year, month] = t.dueDate.split('-');
      return { month: Number(month), year: Number(year) };
    };
    const monthTxs = transactions.filter((t: TransactionResponseDTO) =>
      t.dueDate &&
      getMonthYear(t).month === thisMonth &&
      getMonthYear(t).year === thisYear
    );
    // Totais
    const totalIncome = monthTxs.filter(t => t.type === 'INCOME').reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = monthTxs.filter(t => t.type === 'EXPENSE').reduce((sum, t) => sum + t.amount, 0);
    const netBalance = totalIncome - totalExpense;
    // Montar PDF personalizado
    const doc = new jsPDF();
    // CabeÃ§alho bonito
    doc.setFillColor(102, 126, 234);
    doc.rect(0, 0, 210, 28, 'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(18);
    doc.text('RelatÃ³rio Mensal de TransaÃ§Ãµes', 14, 18);
    doc.setFontSize(12);
    doc.text(`MÃªs: ${String(thisMonth).padStart(2, '0')}/${thisYear}`, 14, 25);
    doc.setTextColor(40,40,40);
    doc.setFontSize(11);
    doc.text(`Total de transaÃ§Ãµes: ${monthTxs.length}`, 14, 35);
    // Tabela
    const headers = ['Tipo', 'TÃ­tulo', 'DescriÃ§Ã£o', 'Valor', 'Status', 'Vencimento'];
    let y = 43;
    doc.setFont(undefined, 'bold');
    headers.forEach((h, i) => doc.text(String(h), 14 + i*32, y));
    doc.setFont(undefined, 'normal');
    y += 8;
    monthTxs.forEach((t, idx) => {
      const row = [
        t.type === 'INCOME' ? 'Receita' : 'Despesa',
        (t as any).title ? String((t as any).title).slice(0, 15) : (t.description || '').slice(0, 15),
        (t.description || '').slice(0, 15),
        t.amount.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }),
        t.status ? String(t.status) : '-',
        t.dueDate && t.dueDate.includes('-') ? (() => { const [y, m, d] = t.dueDate.split('-'); return `${d}/${m}/${y}`; })() : '-'
      ];
      row.forEach((cell, i) => doc.text(String(cell), 14 + i*32, y));
      y += 8;
      if (y > 250 && idx < monthTxs.length - 1) { doc.addPage(); y = 20; }
    });
    // Totais e balanÃ§a
    y += 10;
    doc.setFont(undefined, 'bold');
    doc.setFontSize(12);
    doc.text('Totais do MÃªs:', 14, y);
    doc.setFont(undefined, 'normal');
    doc.setFontSize(11);
    y += 7;
    doc.text(`Receitas: ${totalIncome.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 14, y);
    y += 7;
    doc.text(`Despesas: ${totalExpense.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 14, y);
    y += 7;
    doc.setFont(undefined, 'bold');
    doc.text(`Saldo (BalanÃ§a): ${netBalance.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`, 14, y);
    doc.save(`relatorio-mensal-${String(thisMonth).padStart(2, '0')}-${thisYear}.pdf`);
  };

  const quickActions = [
    { icon: 'âž•', label: 'Criar TransaÃ§Ã£o', action: () => window.location.href = '/criar-transacao' },
    { icon: 'ðŸ“‹', label: 'Visualizar TransaÃ§Ãµes', action: () => window.location.href = '/transacoes' },
    { icon: 'ðŸ“Š', label: 'RelatÃ³rio Mensal', action: handleDownloadMonthlyReport },
  ];

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return '#10b981';
      case 'pending': return '#f59e0b';
      case 'scheduled': return '#3b82f6';
      default: return '#6b7280';
    }
  };

  const handleTransactionClick = (id: string) => {
    const tx = transactions.find(t => t.id === id);
    if (tx) {
      setSelectedTransaction(tx);
      setModalOpen(true);
    }
  };

  const handleCloseModal = () => {
    setModalOpen(false);
    setSelectedTransaction(null);
  };

  if (loading) return <div style={{ padding: 32, textAlign: 'center' }}>Carregando...</div>;
  if (error) return <div style={{ padding: 32, color: 'red', textAlign: 'center' }}>{error}</div>;

  return (
    <div className="dashboard-container">
      {modalOpen && selectedTransaction && (
        <TransactionView transaction={selectedTransaction} onClose={handleCloseModal} />
      )}
      <div className="dashboard-card">
        {/* Header */}
        <div className="dashboard-header">
          <div className="dashboard-title-section">
            <h1 className="dashboard-title">Dashboard</h1>
            <p className="dashboard-subtitle">
              Bem-vindo de volta, {user?.name}! Aqui estÃ¡ o resumo das suas atividades.
            </p>
          </div>
          <div className="dashboard-actions">
            <button className="logout-btn" onClick={handleLogout}>
              Sair
            </button>
          </div>
        </div>

        {/* MÃ©tricas Principais */}
        <div className="metrics-grid">
          {metrics.map((metric, index) => (
            <div key={index} className="metric-card">
              <div className="metric-header">
                <span className="metric-icon">{metric.icon}</span>
                <span className={`metric-trend ${metric.trendType}`}>
                  {metric.trend}
                </span>
              </div>
              <div className="metric-value">{metric.value}</div>
              <div className="metric-label">{metric.label}</div>
              <div className="metric-details">
                {metric.details.map((detail: string, idx: number) => (
                  <div key={idx}>{detail}</div>
                ))}
              </div>
            </div>
          ))}
        </div>

        {/* SeÃ§Ãµes Principais */}
        <div className="dashboard-sections">
          {/* HistÃ³rico de TransaÃ§Ãµes */}
          <div className="section-main">
            <div className="section-header">
              <h3>HistÃ³rico de TransaÃ§Ãµes</h3>
            </div>
            <div className="activities-list" style={{ maxHeight: 340, overflowY: 'auto' }}>
              {recentActivities.slice(0, 10).map((activity, index) => (
                <button
                  key={index}
                  className="activity-item activity-interactive"
                  onClick={() => handleTransactionClick(activity.id)}
                  title="Ver detalhes da transaÃ§Ã£o"
                >
                  <span className="activity-icon">{activity.icon}</span>
                  <div className="activity-content">
                    <div className="activity-message">{activity.message}</div>
                    <div className="activity-time">{activity.time}</div>
                  </div>
                  <div 
                    className="activity-status"
                    style={{ backgroundColor: getStatusColor(activity.status) }}
                  />
                </button>
              ))}
            </div>
          </div>

          {/* Sidebar */}
          <div className="section-sidebar">
            {/* AÃ§Ãµes RÃ¡pidas */}
            <div className="quick-actions">
              <h3>AÃ§Ãµes RÃ¡pidas</h3>
              <div className="action-buttons">
                {quickActions.map((action, index) => (
                  <button
                    key={index}
                    className="quick-action-btn"
                    onClick={action.action}
                  >
                    <span>{action.icon}</span>
                    {action.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Resumo Financeiro */}
            <div className="financial-summary">
              <h3>Resumo Financeiro</h3>
              {financialSummary.map((item, index) => (
                <div
                  key={index}
                  className={`financial-item ${item.total ? 'total' : ''}`}
                  style={index === financialSummary.length - 1 ? { borderBottom: 'none', marginBottom: 0, paddingBottom: 0 } : {}}
                >
                  <span>{item.label}</span>
                  <strong className={item.type}>{item.value}</strong>
                </div>
              ))}
            </div>
          </div>
        </div>

        {/* Status do Sistema */}
        <div className="system-status">
          <div className="status-item">
            <div className="status-dot" />
            <span>Sistema Online</span>
          </div>
          <div className="status-item">
            <div className="status-dot" />
            <span>Dados Sincronizados</span>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Dashboard; 